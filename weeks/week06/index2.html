<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Cell Towers in Oregon (2009)</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web|Oswald" rel="stylesheet">
  <link href="css/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/simplebar.css" />
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
  <script src="js/d3.js"></script>
  <script src="js/c3.min.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/chroma.min.js"></script>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <!-- <script src="js/bootstrap.bundle.min.js"></script> -->
  <script src="js/simplebar.min.js"></script>
</head>

<body>
  <main>
    <div id="mobiledeck">
      <p>
        <span class="mobile-title">Aggr. Confirmed</span>
        <span class="confirmed-count"></span>
        <span class="confirmed-new-count "></span>
      <p>

      <p>
        <span class="mobile-title">Active Confirmed</span>
        <span class="active-count"></span>
        <span class="active-new-count"></span>
      <p>


    </div>

    <div id="info" data-simplebar data-simplebar-auto-hide="true" style="width:520px!important">
      <div id="title" style="font-size:19px">
        <img src="img/virus_logo.png" width="28px">
        Cell Tower in Oregon (2009)
        <span><a href="https://twitter.com/UW" target="_blank"><i class="fab fa-twitter-square"></i></a></span>
        <span><a href="https://github.com/jakobzhao/virus" target="_blank"><i class="fab fa-github-square"></i></a></span>
        <span><a data-toggle="modal" data-target="#infowindow"><i class="nav fas fa-question-circle"></i></a></span>
      </div>

      <p><span id="placename">GLOBAL TREND</span> </p>
      <p><span id="source">Source: </span><span id="source-website" href="" target="_blank"></span></p>
      <div id="deck-1" class="card-deck counts">
        <div class="card">
          <div class="card-body confirmed">
            <h5 class="card-title">Confirmed
              <i class="nav fas fa-exclamation-circle tooltip">
                <span class="tooltiptext">All the confirmed cases ever since the discovery of the COVID-19 in the statistical area.</span>
              </i>
            </h5>
          </div>
          <p class="card-text">
            <span class="confirmed-count"></span><span class="confirmed-new-count">
            </span>
          </p>
        </div>
        <div class="card">
          <div class="card-body death">
            <h5 class="card-title">Death</h5>
            <p class="card-text"><span class="death-count"></span><span class="death-new-count"></span></p>
          </div>
        </div>
      </div>


      <div id="timeline-chart"></div>
      <div id="total-chart"></div>
      <div id="rank-chart"></div>

      <div id="footer">

        <div>
        </div>
        <p align="right" style="margin-right:20px; margin-top:-25px"><a href="https://hgis.uw.edu/2020/03/18/covid-19-novel-coronavirus-infection-map/" target="_blank"><img src="img/logo.png" width="120px"></img></a></p>

      </div>

    </div>

    <div id="legend-panel" class="card-deck legend">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title grey-circles" style="color:black">no case</h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-1">
          <h5 class="card-title" style="color:black">1</h5>

        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-2">
          <h5 class="card-title" style="color:black">100</h5>

        </div>
      </div>
      <div class="card">
        <div class="card-body  legend-color-3">
          <h5 class="card-title" style="color:black">1,000</h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body  legend-color-4">
          <h5 class="card-title" style="color:black">5,000</h5>

        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-5">
          <h5 class="card-title" style="color:black">10,000</h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-6">
          <h5 class="card-title" style="color:black">50,000+</h5>
        </div>
      </div>
    </div>

    <div id="map"></div>

  </main>
  <script>


    //create the base map and set the initial view point
    // 1. Create a map object.
    var mymap = L.map('map', {
        center: [44.13, -119.93],
        zoom: 7,
        maxZoom: 10,
        minZoom: 3,
        detectRetina: true});

    new L.Control.Zoom({
      position: 'topright'
    }).addTo(mymap);


    // 2. Add a base map.
    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(mymap);

    // 3. Add cell towers GeoJSON Data
    // Null variable that will hold cell tower data
    var cellTowers = null;


    // 4. build up a set of colors from colorbrewer's dark2 category
    var colors = chroma.scale('Dark2').mode('lch').colors(9);

    // 5. dynamically append style classes to this page. This style classes will be used for colorize the markers.
    for (i = 0; i < 9; i++) {
        $('head').append($("<style> .marker-color-" + (i + 1).toString() + " { color: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
    }



    var chart, rchart;



    // Get GeoJSON and put on it on the map when it loads
    cellTowers= L.geoJson.ajax("assets/cell_towers.geojson", {
        // assign a function to the onEachFeature parameter of the cellTowers object.
        // Then each (point) feature will bind a popup window.
        // The content of the popup window is the value of `feature.properties.company`
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties.company);
        },
        pointToLayer: function (feature, latlng) {
            var id = 0;
            if (feature.properties.company == "New Cingular") { id = 0; }
            else if (feature.properties.company == "Cellco")  { id = 1; }
            else if (feature.properties.company == "RCC Minnesota")  { id = 2; }
            else if (feature.properties.company == "Verizon")  { id = 3; }
            else if (feature.properties.company == "US Cellular")  { id = 4; }
            else if (feature.properties.company == "Hood River Cellular")  { id = 5; }
            else if (feature.properties.company == "Medford Cellular")  { id = 6; }
            else if (feature.properties.company == "Oregon RSA")  { id = 7; }
            else { id = 8;} // "Salem Cellular"
            return L.marker(latlng, {icon: L.divIcon({className: 'fa fa-signal marker-color-' + (id + 1).toString() })});
        },
        attribution: 'Cell Tower Data &copy; Map Cruzin | Oregon counties &copy; Oregon Explorer | Base Map &copy; CartoDB | Made By Bo Zhao'
    }).addTo(mymap);




    // 6. Set function for color ramp
    colors = chroma.scale('OrRd').colors(5); //colors = chroma.scale('RdPu').colors(5);

    function setColor(density) {
        var id = 0;
        if (density > 18) { id = 4; }
        else if (density > 13 && density <= 18) { id = 3; }
        else if (density > 10 && density <= 13) { id = 2; }
        else if (density > 5 &&  density <= 10) { id = 1; }
        else  { id = 0; }
        return colors[id];
    }


    // 7. Set style function that sets fill color.md property equal to cell tower density
    function style(feature) {
        return {
            fillColor: setColor(feature.properties.CT_CNT),
            fillOpacity: 0.4,
            weight: 2,
            opacity: 1,
            color: '#b4b4b4',
            dashArray: '4'
        };
    }

    // 8. Add county polygons
    // create counties variable, and assign null to it.
    var counties = null;
    counties = L.geoJson.ajax("assets/counties.geojson", {
        style: style
    }).addTo(mymap);


    // 9. Create Leaflet Control Object for Legend
    var legend = L.control({position: 'topright'});

    // 10. Function that runs when legend is added to map
    legend.onAdd = function () {

        // Create Div Element and Populate it with HTML
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<b># Cell Tower</b><br />';
        div.innerHTML += '<i style="background: ' + colors[4] + '; opacity: 0.5"></i><p>19+</p>';
        div.innerHTML += '<i style="background: ' + colors[3] + '; opacity: 0.5"></i><p>14-18</p>';
        div.innerHTML += '<i style="background: ' + colors[2] + '; opacity: 0.5"></i><p>11-13</p>';
        div.innerHTML += '<i style="background: ' + colors[1] + '; opacity: 0.5"></i><p> 6-10</p>';
        div.innerHTML += '<i style="background: ' + colors[0] + '; opacity: 0.5"></i><p> 0- 5</p>';
        div.innerHTML += '<hr><b>Company<b><br />';
        div.innerHTML += '<i class="fa fa-signal marker-color-1"></i><p> New Cingular</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-2"></i><p> Cello</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-3"></i><p> RCC Minnesota</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-4"></i><p> Verizon</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-5"></i><p> US Cellular</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-6"></i><p> Hood River Cellular</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-7"></i><p> Medford Cellular</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-8"></i><p> Oregon RSA</p>';
        div.innerHTML += '<i class="fa fa-signal marker-color-9"></i><p> Salem Cellular</p>';
        // Return the Legend div containing the HTML content
        return div;
    };

    // 11. Add a legend to map
    legend.addTo(mymap);




    //load all datasets through d3 and store them in an array
    Promise.all([
      d3.csv('assets/virus.csv'), //datasets[0]
      d3.json("assets/all-topo-15.json"), //datasets[1]
      //d3.csv('assets/communities.csv'), //chinese cases
      d3.csv('assets/timestamp.txt'), //datasets[3]
      d3.csv('assets/cases.csv'), //America cases
      d3.csv('assets/united-states.txt'), //datasets[5]
      d3.csv('assets/canada-city.txt'), //datasets[6]
      d3.csv('assets/old-name.csv'), //datasets[7] chinese provinces
      d3.csv('assets/cases-canada.csv') //datasets[8]
    ]).then(function(datasets) {


      //read data from cases.csv and add each case on to the map with given information
      //cases in America
      datasets[3].forEach(function(d) {
        //console.log(d.id)
        L.marker([parseFloat(d.lat), parseFloat(d.lng)]).bindPopup("<b>" + d.no + "</b> <p>" + d.note + " identified on " + d.date + ", &nbsp;<a href='https://" + d.reference + "' target='_blank'>" + d.reference + "</a>.</p>").addTo(
          cases);
      })

      //cases in Canada
      datasets[7].forEach(function(d) {
        //console.log(d.id)
        L.marker([parseFloat(d.lat), parseFloat(d.lng)]).bindPopup("<b>" + d.no + "</b> <p>" + d.note + " identified on " + d.date + ", &nbsp;<a href='https://" + d.reference + "' target='_blank'>" + d.reference + "</a>.</p>").addTo(
          cases);
      })


      //this function take a place name and diaplay the data to the info panel
      function showPlace(name) {

        len = places[name].t.length;
        $(".confirmed-count").text(places[name].c[len - 1].toLocaleString());
        $(".recovered-count").text(places[name].r[len - 1].toLocaleString());
        $(".death-count").text(places[name].d[len - 1].toLocaleString());
        $(".active-count").text(places[name].a[len - 1].toLocaleString());

        nc = places[name].c[len - 1] - places[name].c[len - 2]; //new aggregate confirmed cases of the day
        nr = places[name].r[len - 1] - places[name].r[len - 2]; //new recovered confirmed cases of the day
        nd = places[name].d[len - 1] - places[name].d[len - 2]; //new death of the day
        na = places[name].a[len - 1] - places[name].a[len - 2]; //new active cases of the days

        if (nc > 0) {
          $(".confirmed-new-count").text("+" + nc.toLocaleString());
        } else if (nc == 0) {
          $(".confirmed-new-count").text("");
        } else {
          $(".confirmed-new-count").text(nc.toLocaleString());
        }

        if (nr > 0) {
          $(".recovered-new-count").text("+" + nr.toLocaleString());
        } else if (nr == 0) {
          $(".recovered-new-count").text("")
        } else {
          $(".recovered-new-count").text(nr.toLocaleString());
        }
        if (nd > 0) {
          $(".death-new-count").text("+" + nd.toLocaleString());
        } else if (nd == 0) {
          $(".death-new-count").text("")
        } else {
          $(".death-new-count").text(nd.toLocaleString());
        }


        if (na > 0) { //only display info icon when there's change
          document.getElementById("counticon").style.display = "initial";
          $(".active-new-count").text("+" + na.toLocaleString());
        } else if (na < 0) {
          document.getElementById("counticon").style.display = "initial";
          $(".active-new-count").text("" + na.toLocaleString());
        } else if (na == 0) {
          document.getElementById("counticon").style.display = "none";
          $(".active-new-count").text("")
        } else {
          document.getElementById("counticon").style.display = "none";
          $(".active-new-count").text(na.toLocaleString());
        }

        //add ",CHINA" to every provinces in China
        if (datasets[6]["columns"].includes(name)) { //add ",CHINA" to every provinces in China
          $("#placename").text(name.toUpperCase() + ", CHINA");
          if (name == "taiwan") {
            $("#placename").text("Taiwan");
          }
          if (name == "hongkong") {
            $("#placename").text("Hong Kong");
          }
          if (name == "macau") {
            $("#placename").text("Macau");
          }

        } else {
          $("#placename").text(name.toUpperCase());
        }

        //add reference source for each place
        if (datasets[4]["columns"].includes(name)) {
          $("#source-website").html( //Unisted states
            '<a target="_blank" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/"> WHO</a>, <a target="_blank" href="https://www.cdc.gov/coronavirus/2019-ncov/cases-updates/cases-in-us.html?CDC_AA_refVal=https%3A%2F%2Fwww.cdc.gov%2Fcoronavirus%2F2019-ncov%2Fcases-in-us.html">CDC</a>, <a target="_blank" href="https://www.nytimes.com/interactive/2020/us/coronavirus-us-cases.html">New York Times</a>, and <a target="_blank" href="https://www.nbcnews.com/health/health-news/coronavirus-u-s-map-where-virus-has-been-confirmed-across-n1124546">NBC News</a>.'
          );
        } else if (datasets[5]["columns"].includes(name)) { //Canada
          $("#source-website").html('<a target="_blank" href="https://www.canada.ca/en/public-health/services/diseases/2019-novel-coronavirus-infection.html">Public Health Agency of Canada.</a>');
        } else if (datasets[6]["columns"].includes(name)) { //China
          $("#source-website").html(
            '<a target="_blank" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/"> WHO</a>, <a target="_blank" href="http://www.nhc.gov.cn/xcs/xxgzbd/gzbd_index.shtml">China CDC</a>, and <a target="_blank" href="https://voice.baidu.com/act/newpneumonia/newpneumonia">Baidu</a>.'
          );
        } else if (name == "Global Trend") { //global
          $("#source-website").html(
            '<a target="_blank" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/"> WHO</a>, <a target="_blank" href="https://www.nytimes.com/interactive/2020/us/coronavirus-us-cases.html">New York Times</a>, <a target="_blank" href="https://www.nbcnews.com/health/health-news/coronavirus-u-s-map-where-virus-has-been-confirmed-across-n1124546">NBC News</a>, <a target="_blank" href="https://www.cdc.gov/coronavirus/2019-ncov/cases-updates/cases-in-us.html?CDC_AA_refVal=https%3A%2F%2Fwww.cdc.gov%2Fcoronavirus%2F2019-ncov%2Fcases-in-us.html">CDC</a>, <a target="_blank" href="https://voice.baidu.com/act/newpneumonia/newpneumonia">Baidu</a>, <a target="_blank" href="https://en.wikipedia.org/wiki/2019%E2%80%9320_coronavirus_pandemic">Wikipedia</a>, and etc.'
          );
        } else if (name == "japan") { //japan
          $("#source-website").html(
            '<a target="_blank" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/"> WHO</a>, <a target="_blank" href="https://en.wikipedia.org/wiki/2019%E2%80%9320_coronavirus_pandemic">Wikipedia</a>, and <a target="_blank" href="https://voice.baidu.com/act/newpneumonia/newpneumonia">Baidu</a>. The discrepancy on the data in Japan between March 11th and March 12th comes from the disagreement of whether to include cases from the Princess Diamond cruise.'
          );
        } else { //Other countries
          $("#source-website").html(
            '<a target="_blank" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/"> WHO</a>, <a target="_blank" href="https://en.wikipedia.org/wiki/2019%E2%80%9320_coronavirus_pandemic">Wikipedia</a>, and <a target="_blank" href="https://voice.baidu.com/act/newpneumonia/newpneumonia">Baidu</a>.'
          );
        }
      }


      //this function take a place name, return a color that fills the place area on the maps
      //the color is based on the number of active confirmed case
      function setColor(enname) {
        var id = 0;
        var pop = datasets[0][datasets[0].length - 1][enname];

        if (pop != undefined) {
          pop = +pop.toString().split("-")[0] - +pop.toString().split("-")[2] - +pop.toString().split("-")[3]; // remaining confirmed
        } else {
          pop = 0;
          // return "#00000000";
        }

        if (pop >= 50000) {
          id = 5;
        } else if (pop > 10000 && pop <= 50000) {
          id = 4;
        } else if (pop > 5000 && pop <= 10000) {
          id = 3;
        } else if (pop > 1000 && pop <= 5000) {
          id = 2;
        } else if (pop > 100 && pop <= 1000) {
          id = 1;
        } else if (pop > 0 && pop <= 100) {
          id = 0;
        } else {
          id = -1;
          return "#00000000";
        }

        return colors[id];

      }


      //this function works when there's a click on the map
      //will highlight the layer that the mouse clicked
      function highlightFeature(e) {
        // e indicates the current event
        var layer = e.target; //the target capture the object which the event associates with
        layer.setStyle({
          weight: 2,
          opacity: 0.8,
          color: '#e3e3e3',
          fillColor: '#00ffd9',
          fillOpacity: 0.1
        });
        // bring the layer to the front.
        layer.bringToFront();
        if (e.target.feature.properties.enname == "us" || e.target.feature.properties.enname == "canada") {
          layer.bringToBack();
        }
      }

      // 3.2.2 zoom to the highlighted feature when the mouse is clicking onto it.
      function zoomToFeature(e) {
        // mymap.fitBounds(e.target.getBounds());
        L.DomEvent.stopPropagation(e);
        $("#hint").text("Click here to the global trend.");
        displayPlace(e.target.feature.properties.enname)
      }

      // 3.2.3 reset the hightlighted feature when the mouse is out of its region.
      function resetHighlight(e) {
        areas.resetStyle(e.target);

      }

      // 3.3 add these event the layer obejct.
      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          click: zoomToFeature,
          mouseout: resetHighlight
        });
      }

      var areas = new L.TopoJSON(datasets[1], {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(mymap);


      //when click on the tag with "hint" class, the info panel will display global information
      $("#hint").on("click", function() {

        showPlace("Global Trend");
        // calCounts(global);
        chart.load({
          columns: [places["Global Trend"].c, places["Global Trend"].d],
          unload: ['Aggr. Confirmed', 'Death'],
        });

        $("#hint").text("Click a place to review local trend.");

      });

      mymap.on('click', onMapClick);

      function onMapClick(e) {
        $("#hint").click();
      }


      places["Global Trend"] = calPlace("Global Trend");
      showPlace("Global Trend");

      //this set the style for the linechart displayed in info panel
      chart = c3.generate({
        size: {
          height: 350,
          width: 460
        },
        data: {
          x: "t",
          y: "confirmed",
          columns: [places["Global Trend"].t, places["Global Trend"].c, places["Global Trend"].d],
          type: 'line',
          axes: {
            confirmed: 'y'
          },
          colors: {
            'Aggr. Confirmed': '#dc3545',
            // Suspected: 'orange',
            //'Active Confirmed': 'orange',
            //'Recovered': '#28a745',
            'Death': 'SlateBlue'
          }
        },
        zoom: {
          enabled: true,
          type: "scroll"
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              format: "%b %d",
              centered: true,
              fit: true,
              count: 8
            }
          },
          y: {
            label: {
              text: 'Cases',
              position: 'outer-middle'
            },
            min: 0,
            padding: {
              bottom: 0
            },
            tick: {
              format: d3locale.format(",")
            },
            type: 'linear'
          }
        },
        point: {
          r: 3,
          focus: {
            expand: {
              r: 5
            }
          }
        },
        tooltip: {
          linked: true,
        },
        legend: {
          position: 'inset',
          inset: {
            anchor: "top-left",
            y: 0,
            step: 20
          },
        },
        bindto: "#total-chart"
      });


      //this funtion take a place's name and load the linechart with that place's data
      function displayPlace(name) {
        places[name] = calPlace(name);
        showPlace(name);

        chart.load({
          columns: [places[name].c, places[name].d],
          unload: ['Aggr. Confirmed', 'Death'],
        });

      }


      $(".leaflet-control-attribution")
        .css("background-color", "transparent")
        .html("");


    });


  </script>
</body>

</html>
